var engine=function(){"use strict";function e(){c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),p.pos.x=Math.cos(b)*M.distance,p.pos.z=Math.sin(b)*M.distance,p.pos.y=M.distance,p.updateView(),p.render(M.modes[M.mode]),Y&&(b=(b+.02)%(2*Math.PI)),requestAnimationFrame(e)}class t{constructor(){this.viewNeedsUpdate=!0,this.meshes=[],this.pos=BABYLON.Vector3.Zero(),this.rot=BABYLON.Vector3.Zero(),this.scl=new BABYLON.Vector3(1,1,1),this.target=BABYLON.Vector3.Zero(),this.pointLights=[],this.spotLights=[],this.ambientLight={color:BABYLON.Vector4.Zero()}}addMesh(e){return this.meshes.push(e),e}getMesh(e){return this.meshes[e]}removeMesh(e){return this.meshes.splice(e,1)[0]}addPointLight(e,t=new BABYLON.Vector4(1,1,1,1),r=300){let s={pos:new BABYLON.Vector3(e.x,e.y,e.z),color:t,intensity:r};return this.pointLights.push(s),s}getPointLight(e){return this.pointLights[e]}removePointLight(e){return this.pointLights.splice(e,1)[0]}addSpotLight(e,t,r,s=new BABYLON.Vector4(1,1,1,1),i=300){let a={pos:new BABYLON.Vector3(e.x,e.y,e.z),dir:new BABYLON.Vector3(t.x,t.y,t.z),aperture:r,color:s,intensity:i,lookAt:function(e){let t=e.subtract(this.pos);this.dir.x=t.x,this.dir.y=t.y,this.dir.z=t.z}};return this.spotLights.push(a),a}getSpotLight(e){return this.spotLights[e]}removeSpotLight(e){return this.spotLights.splice(e,1)[0]}addAmbientLight(e){return this.ambientLight={color:e},this.ambientLight}removeAmbientLight(){let e=this.ambientLight.color;return this.ambientLight={color:BABYLON.Vector4.Zero()},e}translate(e,t=0,r=0){e instanceof BABYLON.Vector3?this.pos.addInPlace(e):this.pos.addInPlace(new BABYLON.Vector3(e,t,r)),this.viewNeedsUpdate=!0}translateX(e){this.pos.x+=e,this.viewNeedsUpdate=!0}translateY(e){this.pos.y+=e,this.viewNeedsUpdate=!0}translateZ(e){this.pos.z+=e,this.viewNeedsUpdate=!0}scale(e,t=1,r=1){e instanceof BABYLON.Vector3?this.scl.multiplyInPlace(e):this.scl.multiplyInPlace(new BABYLON.Vector3(e,t,r)),this.viewNeedsUpdate=!0}scaleX(e){this.scl.x*=e,this.viewNeedsUpdate=!0}scaleY(e){this.scl.y*=e,this.viewNeedsUpdate=!0}scaleZ(e){this.scl.z*=e,this.viewNeedsUpdate=!0}lookAt(e){this.target=e,this.viewNeedsUpdate=!0}cancelUpdates(){this.viewNeedsUpdate=!1}updateView(){this.uVMatrix=BABYLON.Matrix.LookAtRH(this.pos,new BABYLON.Vector3(this.target.x,this.target.y,this.target.z),BABYLON.Vector3.Up()),this.uPMatrix=BABYLON.Matrix.PerspectiveFovRH(45,window.innerWidth/window.innerHeight,.1,1e4),this.uVInvMatrix=BABYLON.Matrix.Invert(this.uVMatrix),this.viewNeedsUpdate=!1}render(e){this.viewNeedsUpdate&&this.updateView(),this.meshes.forEach(t=>t.display(e,this.uVMatrix,this.uPMatrix,this.uVInvMatrix,this.pointLights,this.spotLights,this.ambientLight))}}class r{constructor(e,t){let r=c.createProgram();if(null===r)throw"Can't create program";this.handle=r;let s=c.createShader(c.VERTEX_SHADER);if(null===s)throw"Can't create vertex shader";let i=c.createShader(c.FRAGMENT_SHADER);if(null===i)throw"Can't create fragment shader";if(c.shaderSource(s,e),c.shaderSource(i,t),c.compileShader(s),0==c.getShaderParameter(s,c.COMPILE_STATUS))throw c.getShaderInfoLog(s);if(c.compileShader(i),0==c.getShaderParameter(i,c.COMPILE_STATUS))throw c.getShaderInfoLog(i);if(c.attachShader(this.handle,s),c.attachShader(this.handle,i),c.bindAttribLocation(this.handle,0,"aPosition"),c.bindAttribLocation(this.handle,1,"aNormal"),c.linkProgram(this.handle),0==c.getProgramParameter(this.handle,c.LINK_STATUS))throw c.getProgramInfoLog(this.handle);if(c.validateProgram(this.handle),0==c.getProgramParameter(this.handle,c.VALIDATE_STATUS))throw c.getProgramInfoLog(this.handle);c.deleteShader(s),c.deleteShader(i)}bind(){c.useProgram(this.handle)}unbind(){c.useProgram(null)}setUniform(e,t){let r=c.getUniformLocation(this.handle,e);null!==r?"number"==typeof t?c.uniform1f(r,t):t instanceof BABYLON.Vector2?c.uniform2fv(r,t.asArray()):t instanceof BABYLON.Vector4?c.uniform4fv(r,t.asArray()):t instanceof BABYLON.Vector3?c.uniform3fv(r,t.asArray()):t instanceof BABYLON.Color4?c.uniform4fv(r,t.asArray()):t instanceof BABYLON.Matrix&&c.uniformMatrix4fv(r,!1,t.asArray()):console.error(`'${e}' uniform variable was not found !`)}}var s;!function(e){e.sync=function(e){let t=new XMLHttpRequest;if(t.open("GET",e,!1),t.send(),4==t.readyState&&200==t.status)return t.responseText},e.async=function(e){return new Promise((t,r)=>{let s=new XMLHttpRequest;s.open("GET",e,!0),s.onload=(e=>{4!=s.readyState||200!=s.status?r(s.status):t(s.responseText)}),s.onerror=(e=>r(e)),s.send()})}}(s||(s={}));var i=s;class a{constructor(){this.vertices=[],this.faces=[],this.vertexNormalsComputed=!1}addVertex(e,t=BABYLON.Vector3.Zero()){this.vertices.push({pos:e,normal:t})}getVertex(e){return e>=0&&e<this.vertices.length?this.vertices[e]:void 0}addFace(e,t,r,s){let i=this.vertices[t].pos.subtract(this.vertices[e].pos),a=this.vertices[r].pos.subtract(this.vertices[e].pos);void 0===s&&(s=BABYLON.Vector3.Normalize(BABYLON.Vector3.Cross(i,a))),this.faces.push({v1:this.vertices[e],v2:this.vertices[t],v3:this.vertices[r],normal:s})}getFace(e){return e>=0&&e<this.faces.length?this.faces[e]:void 0}setNormal(e,t){e>=0&&e<this.vertices.length&&(this.vertices[e].normal=t)}getNormal(e){return e>=0&&e<this.vertices.length?this.vertices[e].normal:void 0}computeVertexNormals(){let e=[];this.vertices.forEach(t=>{let r;if(void 0!=(r=e.find(e=>e.pos.equals(t.pos))))return void(t.normal=r.normal);let s=this.faces.filter(e=>e.v1.pos.equals(t.pos)||e.v2.pos.equals(t.pos)||e.v3.pos.equals(t.pos)),i=BABYLON.Vector3.Zero();s.forEach(e=>i.addInPlace(e.normal)),t.normal=i.normalize(),e.push({pos:t.pos,normal:t.normal})}),this.vertexNormalsComputed=!0}}class o{constructor(e=new a){this.specular=0,this.shininess=1,this.diffuse=1,this.visible=!0,this.matricesNeedUpdate=!0,this.buffersNeedUpdate=!0,this.geometry=e,this.color=new BABYLON.Vector4(0,0,0,1),this.pos=BABYLON.Vector3.Zero(),this.rot=BABYLON.Vector3.Zero(),this.scl=new BABYLON.Vector3(1,1,1)}addShaders(e,t){this.program=new r(e,t)}translate(e,t=0,r=0){e instanceof BABYLON.Vector3?this.pos.addInPlace(e):this.pos.addInPlace(new BABYLON.Vector3(e,t,r)),this.matricesNeedUpdate=!0}translateX(e){this.pos.x+=e,this.matricesNeedUpdate=!0}translateY(e){this.pos.y+=e,this.matricesNeedUpdate=!0}translateZ(e){this.pos.z+=e,this.matricesNeedUpdate=!0}scale(e,t=e,r=e){e instanceof BABYLON.Vector3?this.scl.multiplyInPlace(e):this.scl.multiplyInPlace(new BABYLON.Vector3(e,t,r)),this.matricesNeedUpdate=!0}scaleX(e){this.scl.x*=e,this.matricesNeedUpdate=!0}scaleY(e){this.scl.y*=e,this.matricesNeedUpdate=!0}scaleZ(e){this.scl.z*=e,this.matricesNeedUpdate=!0}rotate(e,t,r){this.rot.x+=e,this.rot.y+=t,this.rot.z+=r,this.matricesNeedUpdate=!0}rotateX(e){this.rot.x+=e,this.matricesNeedUpdate=!0}rotateY(e){this.rot.y+=e,this.matricesNeedUpdate=!0}rotateZ(e){this.rot.z+=e,this.matricesNeedUpdate=!0}setColor(e,t,r,s){e instanceof BABYLON.Vector4?this.color=e:void 0!==t&&void 0!==r?void 0!==s?(this.color.x=e,this.color.y=t,this.color.z=r,this.color.w=s):(this.color.x=e,this.color.y=t,this.color.z=r,this.color.w=1):(this.color.x=e,this.color.y=e,this.color.z=e,this.color.w=e)}updateMatrices(){this.uMMatrix=BABYLON.Matrix.Identity(),this.uMMatrix=BABYLON.Matrix.Translation(this.pos.x,this.pos.y,this.pos.z).multiply(this.uMMatrix),this.uMMatrix=BABYLON.Matrix.Scaling(this.scl.x,this.scl.y,this.scl.z).multiply(this.uMMatrix),this.uMMatrix=BABYLON.Matrix.RotationX(this.rot.x).multiply(this.uMMatrix),this.uMMatrix=BABYLON.Matrix.RotationY(this.rot.y).multiply(this.uMMatrix),this.uMMatrix=BABYLON.Matrix.RotationZ(this.rot.z).multiply(this.uMMatrix),this.uNormalMatrix=BABYLON.Matrix.Transpose(BABYLON.Matrix.Invert(this.uMMatrix)),this.matricesNeedUpdate=!1}computeVertexNormals(){this.geometry.computeVertexNormals(),this.buffersNeedUpdate=!0}genBuffers(){let e=[],t=[],r=[],s=[];c.deleteBuffer(this.vbuffer),c.deleteBuffer(this.nbuffer),c.deleteBuffer(this.wvbuffer),c.deleteBuffer(this.wnbuffer),this.geometry.faces.forEach((i,a)=>{let o,h=[[...i.v1.pos.asArray()],[...i.v2.pos.asArray()],[...i.v3.pos.asArray()]],n=[...i.normal.asArray()];o=this.geometry.vertexNormalsComputed?[[...i.v1.normal.asArray()],[...i.v2.normal.asArray()],[...i.v3.normal.asArray()]]:[n,n,n],e.push(...h[0],...h[1],...h[2]),r.push(...h[0],...h[1],...h[1],...h[2],...h[2],...h[0]),t.push(...o[0],...o[1],...o[2]),s.push(...o[0],...o[1],...o[1],...o[2],...o[2],...o[0])});let i=c.createBuffer();if(null===i)throw"Couldn't create buffer";this.vbuffer=i,c.bindBuffer(c.ARRAY_BUFFER,this.vbuffer),c.bufferData(c.ARRAY_BUFFER,new Float32Array(e),c.STATIC_DRAW),c.bindBuffer(c.ARRAY_BUFFER,null);let a=c.createBuffer();if(null===a)throw"Couldn't create buffer";this.nbuffer=a,c.bindBuffer(c.ARRAY_BUFFER,this.nbuffer),c.bufferData(c.ARRAY_BUFFER,new Float32Array(t),c.STATIC_DRAW),c.bindBuffer(c.ARRAY_BUFFER,null);let o=c.createBuffer();if(null===o)throw"Couldn't create buffer";this.wvbuffer=o,c.bindBuffer(c.ARRAY_BUFFER,this.wvbuffer),c.bufferData(c.ARRAY_BUFFER,new Float32Array(r),c.STATIC_DRAW),c.bindBuffer(c.ARRAY_BUFFER,null);let h=c.createBuffer();if(null===h)throw"Couldn't create buffer";this.wnbuffer=h,c.bindBuffer(c.ARRAY_BUFFER,this.wnbuffer),c.bufferData(c.ARRAY_BUFFER,new Float32Array(s),c.STATIC_DRAW),c.bindBuffer(c.ARRAY_BUFFER,null),this.buffersNeedUpdate=!1}display(e,t,r,s,i,a,o){this.visible&&(this.matricesNeedUpdate&&this.updateMatrices(),this.buffersNeedUpdate&&this.genBuffers(),this.program.bind(),c.bindBuffer(c.ARRAY_BUFFER,e==c.LINES?this.wvbuffer:this.vbuffer),c.vertexAttribPointer(0,3,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,null),c.bindBuffer(c.ARRAY_BUFFER,e==c.LINES?this.wnbuffer:this.nbuffer),c.vertexAttribPointer(1,3,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,null),c.enableVertexAttribArray(0),c.enableVertexAttribArray(1),this.program.setUniform("uMMatrix",this.uMMatrix),this.program.setUniform("uVMatrix",t),this.program.setUniform("uPMatrix",r),this.program.setUniform("uVInvMatrix",s),this.program.setUniform("uALight.color",o.color),this.program.setUniform("uNbPLights",i.length),i.forEach((e,t)=>{this.program.setUniform(`uPLights[${t}].pos`,e.pos),this.program.setUniform(`uPLights[${t}].color`,e.color),this.program.setUniform(`uPLights[${t}].intensity`,e.intensity)}),this.program.setUniform("uNbSLights",a.length),a.forEach((e,t)=>{this.program.setUniform(`uSLights[${t}].pos`,e.pos),this.program.setUniform(`uSLights[${t}].dir`,e.dir),this.program.setUniform(`uSLights[${t}].aper`,e.aperture),this.program.setUniform(`uSLights[${t}].color`,e.color),this.program.setUniform(`uSLights[${t}].intensity`,e.intensity)}),this.program.setUniform("uNormalMatrix",this.uNormalMatrix),this.program.setUniform("color",this.color),this.program.setUniform("diffuse",this.diffuse),this.program.setUniform("specular",this.specular),this.program.setUniform("shininess",this.shininess),c.drawArrays(e,0,(e==c.LINES?2:1)*this.geometry.faces.length*3),c.disableVertexAttribArray(1),c.disableVertexAttribArray(0),this.program.unbind())}static loadObj(e){let t=new o,r=i.sync(e);if(!r)return;let s=[];return r.split("\n").forEach(e=>{let r=e.replace(/\s+/g," ").trim().split(" ");"v"==r[0]?t.geometry.addVertex(new BABYLON.Vector3(parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3]))):"f"==r[0]&&s.push({v1:parseInt(r[1])-1,v2:parseInt(r[2])-1,v3:parseInt(r[3])-1})}),s.forEach(e=>t.geometry.addFace(e.v1,e.v2,e.v3)),t.genBuffers(),t}}class h extends o{constructor(e){super(),this.geometry.addVertex(new BABYLON.Vector3(3,0,0)),this.geometry.addVertex(new BABYLON.Vector3(-3,0,0)),this.geometry.addVertex(new BABYLON.Vector3(0,3,0)),this.geometry.addVertex(new BABYLON.Vector3(0,-3,0)),this.geometry.addVertex(new BABYLON.Vector3(0,0,3)),this.geometry.addVertex(new BABYLON.Vector3(0,0,-3)),this.geometry.addFace(0,2,4),this.geometry.addFace(0,3,4),this.geometry.addFace(0,2,5),this.geometry.addFace(0,3,5),this.geometry.addFace(1,2,4),this.geometry.addFace(1,3,4),this.geometry.addFace(1,2,5),this.geometry.addFace(1,3,5),this.pos=e.pos,this.currentPos=this.pos.clone(),this.setColor(e.color),this.genBuffers();let t=s.sync("shaders/helpers/pointLightHelper/vert.vs"),r=s.sync("shaders/helpers/pointLightHelper/frag.fs");if(void 0===t||void 0===r)throw"LoadingError";this.addShaders(t,r)}display(e,t,r,s,i,a,o){this.currentPos.equals(this.pos)||(this.currentPos=this.pos.clone(),this.updateMatrices()),this.buffersNeedUpdate&&this.genBuffers(),this.program.bind(),c.bindBuffer(c.ARRAY_BUFFER,e==c.LINES?this.wvbuffer:this.vbuffer),c.vertexAttribPointer(0,3,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,null),c.bindBuffer(c.ARRAY_BUFFER,e==c.LINES?this.wnbuffer:this.nbuffer),c.vertexAttribPointer(1,3,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,null),c.enableVertexAttribArray(0),c.enableVertexAttribArray(1),this.program.setUniform("uMMatrix",this.uMMatrix),this.program.setUniform("uVMatrix",t),this.program.setUniform("uPMatrix",r),this.program.setUniform("color",this.color),c.drawArrays(e,0,(e==c.LINES?2:1)*this.geometry.faces.length*3),c.disableVertexAttribArray(1),c.disableVertexAttribArray(0),this.program.unbind()}}class n extends a{constructor(){super(),this.addVertex(new BABYLON.Vector3(-1e3,0,-1e3),BABYLON.Vector3.Up()),this.addVertex(new BABYLON.Vector3(1e3,0,-1e3),BABYLON.Vector3.Up()),this.addVertex(new BABYLON.Vector3(-1e3,0,1e3),BABYLON.Vector3.Up()),this.addVertex(new BABYLON.Vector3(1e3,0,1e3),BABYLON.Vector3.Up()),this.addFace(0,1,2,BABYLON.Vector3.Up()),this.addFace(1,2,3,BABYLON.Vector3.Up()),this.vertexNormalsComputed=!0}}class d extends a{constructor(e,t,r){super();let s=2*Math.PI/r,i=[],a=Math.PI;for(let r=-a;r<=a+s;r+=s){let o=[];i.push(o);for(let i=-a;i<=a+s;i+=s){let s=(e+t*Math.cos(r))*Math.cos(i),a=(e+t*Math.cos(r))*Math.sin(i),h=t*Math.sin(r);o.push({lon:r,lat:i,pos:new BABYLON.Vector3(s,a,h)})}}for(let t=0;t<i.length;t++)for(let r=0;r<i[t].length;r++)this.addVertex(i[t][r].pos,i[t][r].pos.subtractFromFloats(e*Math.cos(i[t][r].lat),e*Math.sin(i[t][r].lat),0));for(let e=0;e<i.length-1;e++)for(let t=0;t<i[e].length-1;t++){let r=t+(e+1)*i[e].length,s=t+e*i[e].length,a=t+1+e*i[e].length,o=t+1+(e+1)*i[e].length;this.addFace(r,s,o),this.addFace(s,a,o)}this.vertexNormalsComputed=!0}}let l=document.getElementById("draw");l.width=window.innerWidth,l.height=window.innerHeight;let c=l.getContext("webgl");if(null==c)throw"WebGL not supported !";c.clearDepth(1),c.depthFunc(c.LEQUAL),c.enable(c.DEPTH_TEST),c.clearColor(0,0,0,1);let p=new t,u={plane:new o(new n),car:o.loadObj("models/test.obj"),dragon:o.loadObj("models/dragon.obj"),teapot:o.loadObj("models/teapot.obj"),crank:o.loadObj("models/crank.obj"),sphere:new o(new d(2,1,50))};if(void 0==u.plane)throw"LoadingError";let f=i.sync("shaders/phongShading/vert.vs"),m=i.sync("shaders/phongShading/frag.fs");if(void 0===f||void 0===m)throw"LoadingError";if(u.plane.addShaders(f,m),u.plane.setColor(1),u.plane.computeVertexNormals(),u.plane.diffuse=1,u.plane.specular=.1,u.plane.shininess=10,p.addMesh(u.plane),void 0==u.car)throw"LoadingError";if(u.car.addShaders(f,m),u.car.setColor(1),u.car.translateX(100),u.car.scale(15),u.car.diffuse=15,u.car.specular=5,u.car.shininess=10,p.addMesh(u.car),void 0==u.dragon)throw"LoadingError";if(u.dragon.addShaders(f,m),u.dragon.setColor(1),u.dragon.scale(50),u.dragon.rotateX(-10*Math.PI/180),u.dragon.translateY(25),u.dragon.diffuse=50,u.dragon.specular=1,u.dragon.shininess=10,u.dragon.translateZ(-50),p.addMesh(u.dragon),void 0==u.teapot)throw"LoadingError";if(u.teapot.addShaders(f,m),u.teapot.setColor(1),u.teapot.scale(10),u.teapot.computeVertexNormals(),u.teapot.diffuse=10,u.teapot.specular=1,u.teapot.shininess=10,u.teapot.translateZ(50),p.addMesh(u.teapot),void 0==u.crank)throw"LoadingError";if(u.crank.addShaders(f,m),u.crank.setColor(1),u.crank.scale(30),u.crank.diffuse=30,u.crank.specular=1,u.crank.shininess=30,u.crank.translateX(-100),u.crank.translateY(50),p.addMesh(u.crank),void 0==u.sphere)throw"LoadingError";u.sphere.addShaders(f,m),u.sphere.setColor(1),u.sphere.scale(20),u.sphere.diffuse=20,u.sphere.specular=1,u.sphere.shininess=20,u.sphere.translateX(-100),u.sphere.translateY(150),p.addMesh(u.sphere);let B=p.addPointLight(new BABYLON.Vector3(100,20,20),new BABYLON.Vector4(39/255,174/255,96/255,1)),g=p.addPointLight(new BABYLON.Vector3(-60,100,20),new BABYLON.Vector4(231/255,76/255,60/255,1)),A=p.addSpotLight(new BABYLON.Vector3(400,400,400),new BABYLON.Vector3(400,400,400),30,new BABYLON.Vector4(1,1,1,1),100);A.lookAt(BABYLON.Vector3.Zero());p.addMesh(new h(B)),p.addMesh(new h(g));let L=p.addMesh(new h(A));p.lookAt(BABYLON.Vector3.Zero());let N=0,v=.01,w=0,x=0;setInterval(()=>{B.pos.x=50*Math.cos(N),B.pos.y=50*Math.sin(N),g.pos.x=50*Math.cos(w),g.pos.z=50*Math.sin(w),A.pos.x=400*Math.cos(x),A.pos.z=400*Math.sin(x),A.lookAt(BABYLON.Vector3.Zero()),N>=Math.PI?v=-.01:N<=0&&(v=.01),N+=v,w>=2*Math.PI&&(w=0),w+=.01,x>=2*Math.PI&&(x=0),x+=-.005,p.getMesh(3).rotateY(.01),p.getMesh(4).rotate(.01,.01,.01),u.sphere.rotate(.01,.01,.01)}),console.log(p);let b=0,Y=!1,M={modes:[c.TRIANGLES,c.LINES,c.POINTS],mode:0,distance:200};document.addEventListener("contextmenu",e=>e.preventDefault()),document.addEventListener("mousewheel",e=>M.distance-=e.deltaY>0?-10:10),document.addEventListener("keypress",e=>{"w"==e.key?M.mode=(M.mode+1)%3:"e"==e.key&&(Y=!Y)});let y=new dat.GUI({autoPlace:!0,name:"Scene control"}),V=y.addFolder("Scene");return V.add(M,"distance",0,750),V.add(M,"mode",{Standard:0,Wireframe:1,Points:2}),(V=y.addFolder("Spotlight")).add(A,"intensity",0,700),V.add(L,"visible"),(V=V.addFolder("Color")).add(A.color,"x",0,1),V.add(A.color,"y",0,1),V.add(A.color,"z",0,1),V.add(A.color,"w",0,1),e(),c}();
